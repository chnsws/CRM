<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <title>部门和用户设置</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="{$_GET['public_dir']}/index_js_css/css/global.css" media="all">
    <link rel="stylesheet" href="{$_GET['public_dir']}/index_js_css/plugins/font-awesome/css/font-awesome.min.css">
    <script src="{$_GET['public_dir']}/jquery/jquery.js"></script>
    <!--layUI 插件 --弹窗设计 form表单样式 -->
    <script src="{$_GET['public_dir']}/index_js_css/plugins/layui/layui.js"> </script>
    <link rel="stylesheet" href="{$_GET['public_dir']}/index_js_css/plugins/layui/css/layui.css" media="all">
    <!--UIkit-->
    <link rel="stylesheet" href="{$_GET['public_dir']}/uikit/css/uikit.almost-flat.min.css" />
    <script src="{$_GET['public_dir']}/uikit/js/uikit.min.js"></script>
     <link rel="stylesheet" href="{$_GET['public_dir']}/uikit/css/components/accordion.css" />
     <link rel="stylesheet" href="{$_GET['public_dir']}/uikit/css/components/sortable.css" />
    <style>
        *{margin:0;padding:0;}
        #box div{overflow:hidden;}
        a{text-decoration:none;cursor:pointer;color:#333;}
        ul{list-style:none;}
        #box{margin-left:10px;margin-right:10px;}
        
        #mod-head{height:100px;font-size:22px;line-height:100px;color:#1AA094;font-weight:bold;}
        #mod1{background-color:#DFF0D8;height:100px;color:#255B56;padding-left:15px;padding-top:10px;padding-bottom:0px;border-radius:0px;}
        #mod1 div{height:22px;font-size:12px;}
        #hidden-div{float:right;font-weight:bold;margin-right:15px;font-size:20px;color:#656565;}
        .left-mar{padding-left:37px;}
        tr{height:50px;}
        /*mod2下方选项卡*/
        .fa-reorder{margin-left:10px;}
        /*隐藏的table 弹出层table*/
        #hid_table{width:560px;margin-left:20px;margin-right:20px;}
        #hid_table tr{height:70px;}
        .hid_tab_left{font-weight:bold;width:100px;}
        .teshu{color:#656565;margin-left:10px;}
        /*产品分类模块的独立样式*/
        .uk-accordion-title{font-size:14px;height:40px;line-height:40px;font-weight: bold;background: #f9f9f9;border:1px solid #ccc;border-left: 5px solid #1AA094;}
        #cpfl_list table thead{background:#F2F2F2;border:1px solid #E2E2E2;}
        #cpfl_list table thead th{text-align: center;}
    </style>
</head>

<body>
<div id="box">
    <!--头部文字-->
    <div id="mod-head">
    自定义业务字段
    </div>
    <!--头部结束-->
    <!--中部提示-->
    <div id="mod1">
        <div>提示：1.字段设置为启用，在系统中显示此字段和字段对应的数据；如果未启用则不显示。<span id="hidden-div"><a onclick="hidden_div()">×</a></span></div>
        <div class="left-mar">2.字段设置为必填，在系统中新增编辑时显示*，必须填写或选择后才能保存。</div>
        <div class="left-mar">3.字段设置为常用，在系统中新增编辑时默认直接显示；如果没有勾选则需展开后才能显示。</div>
        <div class="left-mar">4.每个功能模块中，最多可添加15个自定义字段和最多支持8个区块。</div>
    </div>
    <!--中部结束-->
    <!--下部数据展示模块-->
    <div id="mod2">
        <div class="layui-tab layui-tab-card">
            <ul class="layui-tab-title">
                <li class="layui-this"  onclick="changepage('paixu_xiansuo')" id="lipaixu_xiansuo">线索</li>
                <li id="lipaixu_kehu" onclick="changepage('paixu_kehu')">客户</li>
                <li id="lipaixu_lianxiren" onclick="changepage('paixu_lianxiren')">联系人</li>
                <li id="lipaixu_shangji" onclick="changepage('paixu_shangji')">商机</li>
                <li id="lipaixu_hetong" onclick="changepage('paixu_hetong')">合同</li>
                <li id="lipaixu_chanpin" onclick="changepage('paixu_chanpin')">产品</li>
            </ul>
            <div class="layui-tab-content" >
                <!--线索-->
                <div class="layui-tab-item layui-show">
                    <button onclick="xinzeng('xiansuo')" class="layui-btn">新增字段</button>
                    <table class="layui-table" lay-skin="line" id="paixu_xiansuo">
                        <thead>
                            <th width="60px">排序</th>
                            <th>字段名称</th>
                            <th width="200px">启用</th>
                            <th width="200px">必填</th>
                            <th width="200px">常用</th>
                            <th>操作</th>
                        </thead>
                        {$tablestr}
                    </table>
                </div>
                <!--客户-->
                <div class="layui-tab-item">
                    <button onclick="xinzeng('kehu')" class="layui-btn">新增字段</button>
                    <table class="layui-table" lay-skin="line" id="paixu_kehu">
                        <thead>
                            <th width="60px">排序</th>
                            <th>字段名称</th>
                            <th width="200px">启用</th>
                            <th width="200px">必填</th>
                            <th width="200px">常用</th>
                            <th>操作</th>
                        </thead>
                        <tbody class="paixu_tbody">
                        </tbody>
                    </table>
                </div>
                <!--联系人-->
                <div class="layui-tab-item">
                    <button onclick="xinzeng('lianxiren')" class="layui-btn">新增字段</button>
                    <table class="layui-table" lay-skin="line" id="paixu_lianxiren">
                        <thead>
                            <th width="60px">排序</th>
                            <th>字段名称</th>
                            <th width="200px">启用</th>
                            <th width="200px">必填</th>
                            <th width="200px">常用</th>
                            <th>操作</th>
                        </thead>
                        <tbody class="paixu_tbody">
                        </tbody>
                    </table>
                </div>
                <!--商机-->
                <div class="layui-tab-item">
                    <button onclick="xinzeng('shangji')" class="layui-btn">新增字段</button>
                    <table class="layui-table" lay-skin="line" id="paixu_shangji">
                        <thead>
                            <th width="60px">排序</th>
                            <th>字段名称</th>
                            <th width="200px">启用</th>
                            <th width="200px">必填</th>
                            <th width="200px">常用</th>
                            <th>操作</th>
                        </thead>
                        <tbody class="paixu_tbody">
                        </tbody>
                    </table>
                </div>
                <!--合同-->
                <div class="layui-tab-item">
                    <button onclick="xinzeng('hetong')" class="layui-btn">新增字段</button>
                    <table class="layui-table" lay-skin="line" id="paixu_hetong">
                        <thead>
                            <th width="60px">排序</th>
                            <th>字段名称</th>
                            <th width="200px">启用</th>
                            <th width="200px">必填</th>
                            <th width="200px">常用</th>
                            <th>操作</th>
                        </thead>
                        <tbody class="paixu_tbody">
                        </tbody>
                    </table>
                </div>
                <!--产品-->
                <div class="layui-tab-item">
                        <div class="uk-accordion" id="cpfl_list" data-uk-accordion="{collapse: false}">

                            

                        </div>
                    <!--
                    <button onclick="xinzeng('chanpin')" class="layui-btn">新增字段</button>
                    <table class="layui-table" lay-skin="line" id="paixu_chanpin">
                        <thead>
                            <th width="60px">排序</th>
                            <th>字段名称</th>
                            <th width="200px">启用</th>
                            <th width="200px">必填</th>
                            <th width="200px">常用</th>
                            <th>操作</th>
                        </thead>
                        <tbody class="paixu_tbody">
                        </tbody>
                    </table>
                    -->
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<table id="hid_table">
    <tr>
        <td class="hid_tab_left">显示名称</td>
        <td><input type="text" placeholder="请填写显示名称，最长12个字符" id="newzdname" class="layui-input"/></td>
    </tr>
    <!--
    <tr>
        <td valign="top" class="hid_tab_left">输入提示</td>
        <td ><input type="text" placeholder="输入提示，不超过25个字符" id="" class="layui-input"/><br>显示在输入框里面的提示用户输入的灰色文字，如： 请输入客户名称</td>
    </tr>
    -->
</table>
<script src="{$_GET['public_dir']}/paixu/build.js"></script>
<script>
    window.nowpage='paixu_xiansuo';
    window.root_dir="{$_GET['root_dir']}";
    window.public_dir="{$_GET['public_dir']}";
    window.pageinfo="{$_GET['page']}";

    window.load_xiansuo='1';
    window.load_kehu='0';
    window.load_lianxiren='0';
    window.load_shangji='0';
    window.load_hetong='0';
    window.load_chanpin='0';

    window.tuozhuai_fl='';
    $("#hid_table").hide();
    //上方绿色提示框的关闭效果
    function hidden_div(){
        $("#mod1").hide();
    }

 
    if(pageinfo!='')
    {
        
        $("#lipaixu_xiansuo").attr("class",'');
        $("#li"+pageinfo).attr("class","layui-this");
        $("#paixu_xiansuo").parent().removeClass("layui-show");
        if(pageinfo=="paixu_chanpin")
        {
            $("#cpfl_list").parent().addClass("layui-show");
        }
        else
        {
            $("#"+pageinfo).parent().addClass("layui-show");
        }
        
        //alert(pageinfo)
        window.nowpage=pageinfo;
        loadpage(pageinfo);
    }

    //ajax同步
    $.ajaxSetup({
        async : false
    });
    //初始化
    layui.use('layer', function(){
        window.layer = layui.layer;
    });
    //初始化layui的基础组件
    layui.use('element', function(){
         var element = layui.element();
    });
    //黑色半透明提示
    function tishi(neirong)
    {
        layer.msg(neirong, {
            time: 1000, 
        });
    }
    //修改当前页面的参数
    function changepage(pageid)
    {
        window.nowpage=pageid;
        if(pageid=='paixu_xiansuo')
        {
            if(load_xiansuo=='1')
            return false;
        }
        if(pageid=='paixu_kehu')
        {
            if(load_kehu=='1')
            return false;
        }
        if(pageid=='paixu_lianxiren')
        {
            if(load_lianxiren=='1')
            return false;
        }
        if(pageid=='paixu_shangji')
        {
            if(load_shangji=='1')
            return false;
        }
        if(pageid=='paixu_hetong')
        {
            if(load_hetong=='1')
            return false;
        }
        if(pageid=='paixu_chanpin')
        {
            if(load_chanpin=='1')
            return false;
        }
        //加载层
        window.jiazai= layer.load(2);
        loadpage(pageid);
    }
    //新增字段按钮
    var xz_is_click=0;
    function xinzeng(mod)
    {
        $("#newzdname").val('');
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
                type:1,
                area:"600px",
                title:"新增字段",
                content: $("#hid_table"),
                btn: '保存',
                btn1: function(index, layero){
                        if(xz_is_click!=0)
                        {
                            return;
                        }
                        xz_is_click=1;
                        setTimeout(function() {
                            xz_is_click=0;
                        }, 3000);
                        var newzdname=$("#newzdname").val();
                        if(newzdname=='')
                        {
                            tishi("字段名不能为空");
                            return false;
                        }
                        if(newzdname.length>12)
                        {
                            tishi("字段名不能超过12个字符");
                            return false;
                        }
                        if(!newzdname.match(/^[\u4e00-\u9fa5_a-zA-Z0-9]+$/))
                        {
                            tishi("字段名只能由中文、字母、数字和下划线组成");
                            return false;
                        }
                        var jsondata={"thispage":nowpage,"ziduanname":newzdname};
                        if(nowpage=="paixu_chanpin")
                        {
                            var thisflid='7,'+$(mod).next().children("tbody").prop("id").substr(14);
                            thisflname=$(mod).parent().parent().prev().text();
                            jsondata={"thispage":thisflid,"ziduanname":newzdname,"thisflname":thisflname};
                        }
                        window.jiazai= layer.load(2);
                        $.get(root_dir+"/index.php/Home/YewuziduanDo/addziduan",jsondata,function(res){
                            layer.close(jiazai);
                            if(res=='1')
                            {
                                window.location=root_dir+"/index.php/Home/Option/zdyyw_ziduan?page="+nowpage;
                            }
                            else if(res=='2')
                            {
                                tishi("添加失败");
                            }
                            else if(res=='3')
                            {
                                tishi("该字段已存在，请重新输入");
                            }
                            else
                            {
                                tishi("添加失败，请刷新后重试");
                            }
                        });  
                    }
            });
        });
    }
    //点击编辑事件
    function bianji(thisid,candel,fl_id)
    {
        
        var oldname=nowpage=='paixu_chanpin'?$("#tbody_chanpin_"+fl_id).children("#"+thisid).children("td").eq(1).text():$("#"+nowpage).find("#"+thisid).children("td").eq(1).text();
        var flname=nowpage=='paixu_chanpin'?$("#tbody_chanpin_"+fl_id).parent().parent().parent().prev().text():'';
        $("#newzdname").val(oldname);
        if(candel=='1')
        {
            var btnarr=['保存','删除','取消'];
        }
        else
        {
            var btnarr=['保存','取消'];
        }
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
                type:1,
                area:"600px",
                title:"编辑字段",
                content: $("#hid_table"),
                btn: btnarr,
                btn1: function(index, layero){
                        var newname=$("#newzdname").val();
                        if(newname=='')
                        {
                            tishi("字段名不能为空");
                            return false;
                        }
                        if(newname==oldname)
                        {
                            tishi("修改成功");
                            layer.close(index); 
                            return false;
                        }
                        var nowpage2=nowpage;
                        nowpage=nowpage=="paixu_chanpin"?'7,'+fl_id:nowpage;
                        $.get(root_dir+"/index.php/Home/YewuziduanDo/changename",{"nowpage":nowpage,"newname":newname,"changeid":thisid,"flname":flname},function(res){
                            nowpage=nowpage2;
                            if(nowpage=="paixu_chanpin")
                            {
                                $("#tbody_chanpin_"+fl_id).children("#"+thisid).children("td").eq(1).text(newname);
                            }
                            else
                            {
                                $("#"+nowpage).find("#"+thisid).children("td").eq(1).text(newname);
                            }
                            tishi("修改成功");
                        });
                        layer.close(index); 
                    },
                btn2:function(index,layero){
                    if(candel!='1')
                    {
                        layer.close(index);
                        return false;
                    }
                    var delts=layer.msg('确认删除字段‘'+oldname+'’？删除后将无法恢复。', {
                        time: 2000000, //20s后自动关闭
                        btn: ['确认删除', '取消'],
                        btn1: function(){
                            //加载层
                            window.jiazai= layer.load(2);
                            var nowpage2=nowpage;
                            nowpage=nowpage=="paixu_chanpin"?'7,'+fl_id:nowpage;
                            $.get(root_dir+"/index.php/Home/YewuziduanDo/delzd",{"nowpage":nowpage,"changeid":thisid,"flname":flname},function(res){
                                nowpage=nowpage2;
                                if(nowpage=="paixu_chanpin")
                                {
                                    $("#tbody_chanpin_"+fl_id).children("tr[id='"+thisid+"']").remove();
                                    window.tuozhuai_fl=fl_id;
                                    getshunxu();
                                }
                                else
                                {
                                    $("#"+nowpage).find("tr[id='"+thisid+"']").remove();
                                }
                                
                                layer.close(jiazai);
                            });
                            layer.close(delts);
                        },
                        btn2: function(){
                            layer.close(delts);
                        }
                    });
                },
                btn3:function(index,layero)
                {
                    layer.close(index);
                }
            });
        });
    }
    
    //拖拽监听事件
    function tuozhuai()
    {
        var mouseval='0';
        $(".tuozhuaiclass").on({
            //当鼠标按下时，将鼠标值改为1（标记鼠标已经按下）
            mousedown:function(){
                //alert($(this).parent().parent().prop("id"));
                window.tuozhuai_fl=$(this).parent().parent().prop("id").substr(14);
                mouseval='1';
                $(".tuozhuaiclass").on({
                    mousemove:function(){
                        //当鼠标为按下状态时（鼠标值为1时），然后再拖动时，将鼠标值改为2（标记鼠标按下并拖动）
                        if(mouseval=='1')
                        {
                            mouseval='2';
                            $("body").on({
                                mouseup:function(){
                                    if(mouseval=='2')
                                    {
                                        //加载层
                                        window.jiazai= layer.load(2);
                                        setTimeout("getshunxu()",100);
                                        //当鼠标按下并拖动后，然后再松开鼠标时，完成整个拖动事件
                                        mouseval='0';//还原鼠标值，用来进行下一次拖动判断
                                    }
                                }
                            })
                        }
                    }
                })
            }
        })
    }
    tuozhuai();
    //获取顺序并进行数据库更新
    function getshunxu()
    {
        var shunxu='';
        var nowpage2=nowpage;
        if(nowpage=="paixu_chanpin")
        {
            /*
            $("#cpfl_list").find("table").each(function(){
                var this_fl_id=$(this).children("tbody").prop("id").substr(14);
                shunxu+=this_fl_id+":";
                $(this).children("tbody").find("tr").each(function(){
                    if($(this).attr("id")!=undefined)
                    {
                        shunxu+=$(this).attr("id")+',';  
                    }
                });
                shunxu=shunxu.substr(0,shunxu.length-1);
                shunxu+="|";
            });
            */
            nowpage='7,'+window.tuozhuai_fl;
            $("#tbody_chanpin_"+window.tuozhuai_fl).find("tr").each(function(){
                if($(this).attr("id")!=undefined)
                {
                    shunxu+=$(this).attr("id")+',';  
                }
            });
        }
        else
        {
            $("#"+nowpage).find("tr").each(function(){
                if($(this).attr("id")!=undefined)
                {
                    shunxu+=$(this).attr("id")+',';  
                }
            });
        }
        $.post(root_dir+"/index.php/Home/YewuziduanDo/paixu",{"thispage":nowpage,"shunxu":shunxu},function(res){
            //alert(res);
            if(res=='1')
            {
                
            }
            else if(res=='2')
            {
                tishi("排序失败");
            }
            else
            {
                tishi("修改排序失败，请刷新后重试");
            }
            nowpage=nowpage2;
        });
        layer.close(jiazai);
    }
    //改变复选框中的值
    function changecheckboxfun()
    {
        //改变复选框中的值触发事件
        $("input[type='checkbox']").change(function(){
            //加载层
            window.jiazai= layer.load(2);
            var changeval=$(this).prop('checked');
            var changename=$(this).attr("name");
            var thisflname='';
            var nowpage2=nowpage;
            if(nowpage=="paixu_chanpin")
            {
                //获取分类产品id
                var thisflid=$(this).parent().parent().parent().prop("id").substr(14);
                nowpage='7,'+thisflid;
                thisflname=$(this).parent().parent().parent().parent().parent().parent().prev().text();
            }
            $.get(root_dir+"/index.php/Home/YewuziduanDo/changecheckbox",{"nowpage":nowpage,"changeval":changeval,"changename":changename,"thisflname":thisflname},function(res){
                if(res=='1')
                {
                    
                }
                else if(res=='2')
                {
                    tishi("修改失败");
                }
                else
                {
                    tishi("修改失败，请刷新后重试");
                }
            });
            nowpage=nowpage2;
            layer.close(jiazai);
        });
    }
    changecheckboxfun();
    //动态加载页面
    function loadpage(pageid)
    {
        //对产品页面进行特殊处理
        if(pageid=='paixu_chanpin')
        {
            $.post(root_dir+"/index.php/Home/YewuziduanDo/zd_for_chanpin",function(res){
                setTimeout(function() {
                    $("#cpfl_list").html(res);
                    $.getScript("{$_GET['public_dir']}/uikit/js/components/sortable.js");
                    $.getScript("{$_GET['public_dir']}/uikit/js/components/accordion.js");
                    //alert($("#cpfl_list").find("tbody").length);
                    $("#cpfl_list").find("table").each(function(){
                        $(this).css("margin-top","20px");
                        var thistabledom=$(this);
                        $(this).children("thead").children("tr").children("th").each(function(){
                            var this_th_width=$(this).css("width");
                            var this_th_height=$(this).css("height");
                            var this_th_index=$(this).index();
                            thistabledom.children("tbody").find("tr").each(function(){
                                $(this).css({"border":"1px solid #E2E2E2","border-right":"none","border-left":"none"});
                                //alert($(this).css("width"))
                                $(this).children("td").eq(this_th_index).css({"width":this_th_width,"height":this_th_height,"text-align":"center","background":"#fff","line-height":"50px"});
                            });
                        });
                    });
                    tuozhuai();
                    changecheckboxfun();
                    //alert(res)
                    layer.close(window.jiazai);
                    load_chanpin='1';
                }, 100);
            });
        }
        else
        {
            $.get(root_dir+"/index.php/Home/YewuziduanDo/loadpage",{"thispage":pageid},function(res){
                $("#"+pageid).children(".paixu_tbody").html(res);
                loadScript();
                tuozhuai();
                changecheckboxfun();
                layer.close(jiazai);
            });
            if(pageid=='paixu_xiansuo')
            {
                load_xiansuo='1';
            }
            if(pageid=='paixu_kehu')
            {
                load_kehu='1';
            }
            if(pageid=='paixu_lianxiren')
            {
                load_lianxiren='1';
            }
            if(pageid=='paixu_shangji')
            {
                load_shangji='1';
            }
            if(pageid=='paixu_hetong')
            {
                load_hetong='1';
            }
        }
    }
    // 动态加载js脚本文件
    function loadScript() {
        var script = document.createElement("script");
            script.type = "text/javascript";
        script.src = public_dir+"/paixu/build.js";
        document.body.appendChild(script);
    }
</script>
</html>

